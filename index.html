<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –°–≤—ñ—Ç–ª–∞</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    :root {
      --bg-color: #f0f2f5;
      --card-bg: #ffffff;
      --text-main: #1a1a1a;
      --text-sec: #65676b;
      --green: #34c759;
      --red: #ff3b30;
      --accent: #007bff;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #121212;
        --card-bg: #1e1e1e;
        --text-main: #e4e6eb;
        --text-sec: #b0b3b8;
        --input-bg: #2c2c2e;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      margin: 0;
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
    }

    .container {
      width: 100%;
      max-width: 600px;
    }

    /* Status Card */
    .status-card {
      background-color: var(--card-bg);
      border-radius: 20px;
      padding: 25px 20px;
      text-align: center;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }

    .icon { font-size: 3.5rem; margin-bottom: 5px; display: block; }
    .status-text { font-size: 2rem; font-weight: 800; margin: 0; line-height: 1.2;}
    .duration-text { font-size: 1.2rem; font-weight: 500; margin-top: 5px; color: var(--text-sec); }
    .status-sub { color: var(--text-sec); margin-top: 10px; font-size: 0.8rem; opacity: 0.7;}
    .online { color: var(--green); }
    .offline { color: var(--red); }

    /* Controls */
    .controls {
      display: flex;
      background: var(--card-bg);
      padding: 5px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      margin-bottom: 15px;
      justify-content: space-between;
    }

    .time-btn {
      flex: 1;
      border: none;
      background: transparent;
      color: var(--text-sec);
      padding: 10px 0;
      font-size: 0.9rem;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .time-btn.active {
      background-color: var(--text-main);
      color: var(--card-bg);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .chart-card {
      background-color: var(--card-bg);
      border-radius: 20px;
      padding: 15px 10px;
      box-shadow: var(--shadow);
      height: 320px;
      position: relative;
      margin-bottom: 20px;
      overflow: hidden;
    }

    /* CHART LOADER OVERLAY */
    .chart-loader {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255, 255, 255, 0.8);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
      backdrop-filter: blur(2px);
      border-radius: 20px;
    }
    @media (prefers-color-scheme: dark) {
      .chart-loader { background: rgba(30, 30, 30, 0.8); }
    }

    .spinner {
      width: 40px; height: 40px;
      border: 4px solid var(--text-sec);
      border-top: 4px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }
    .loader-text { font-weight: bold; color: var(--text-main); }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Settings */
    .settings-card {
      background-color: var(--card-bg);
      border-radius: 15px;
      padding: 15px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .settings-label { font-size: 0.8rem; color: var(--text-sec); text-transform: uppercase; letter-spacing: 1px; font-weight: bold;}
    .input-group { display: flex; gap: 10px; }
    input {
      flex: 1; padding: 10px; border-radius: 8px;
      border: 1px solid var(--text-sec); background: var(--bg-color); color: var(--text-main); font-size: 1rem;
    }
    .save-btn {
      background-color: var(--accent); color: white; border: none; padding: 0 20px; border-radius: 8px; font-weight: bold; cursor: pointer;
    }
    .debug-info { font-size: 0.75rem; color: var(--text-sec); margin-top: 5px; }

    #pageLoading {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg-color); display: flex; justify-content: center;
      align-items: center; z-index: 1000; font-size: 1.2rem; font-weight: bold;
    }
  </style>
</head>
<body>

<div id="pageLoading">–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...</div>

<div class="container">
  <div class="status-card" id="statusCard">
    <span class="icon" id="statusIcon">‚ö°</span>
    <h1 class="status-text" id="statusText">–ê–Ω–∞–ª—ñ–∑...</h1>
    <div class="duration-text" id="durationText">–ó–∞—á–µ–∫–∞–π—Ç–µ</div>
    <div class="status-sub" id="lastSeen"></div>
  </div>

  <div class="controls">
    <button class="time-btn" onclick="setRange(6, this)">6 –≥–æ–¥</button>
    <button class="time-btn active" onclick="setRange(12, this)">12 –≥–æ–¥</button>
    <button class="time-btn" onclick="setRange(24, this)">24 –≥–æ–¥</button>
    <button class="time-btn" onclick="setRange(168, this)">7 –¥–Ω—ñ–≤</button>
  </div>

  <div class="chart-card">
    <div class="chart-loader" id="chartLoader">
      <div class="spinner"></div>
      <div class="loader-text">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞—Ä—Ö—ñ–≤—É...</div>
    </div>
    <canvas id="powerChart"></canvas>
  </div>

  <div class="settings-card">
    <div class="settings-label">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–∞–Ω–∞–ª—É</div>
    <div class="input-group">
      <input type="text" id="channelInput" placeholder="ThingSpeak Channel ID">
      <button class="save-btn" onclick="saveChannel()">OK</button>
    </div>
    <div class="debug-info" id="debugInfo"></div>
  </div>
</div>

<script>
  const defaultChannel = '2013961';
  let currentChannelId = localStorage.getItem('ts_channel_id') || defaultChannel;
  document.getElementById('channelInput').value = currentChannelId;

  let detectedTimeoutMinutes = 5;
  let powerChartInstance = null;
  let globalFeeds = [];
  let isFullHistoryLoaded = false;

  async function initialLoad() {
    const URL = `https://api.thingspeak.com/channels/${currentChannelId}/feeds.json?results=1500`;
    try {
      const response = await fetch(URL);
      if (!response.ok) throw new Error("Channel not found");
      const data = await response.json();

      globalFeeds = data.feeds;
      detectedTimeoutMinutes = calculate3xTimeout(globalFeeds);
      updateCurrentStatus(globalFeeds);

      setRange(12, document.querySelector('.time-btn.active'));

      document.getElementById('pageLoading').style.display = 'none';
    } catch (error) {
      handleError(error);
    }
  }

  async function loadFullHistory(btnElement) {
    const loader = document.getElementById('chartLoader');
    loader.style.display = 'flex';
    const URL = `https://api.thingspeak.com/channels/${currentChannelId}/feeds.json?results=8000`;
    try {
      const response = await fetch(URL);
      const data = await response.json();

      globalFeeds = data.feeds;
      isFullHistoryLoaded = true;
      detectedTimeoutMinutes = calculate3xTimeout(globalFeeds);

      drawChart(168);
      updateButtons(btnElement);
    } catch (error) {
      console.error(error);
      alert("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞—Ä—Ö—ñ–≤—É.");
    } finally {
      loader.style.display = 'none';
    }
  }

  function setRange(hours, btnElement) {
    if (hours === 168 && !isFullHistoryLoaded) {
      loadFullHistory(btnElement);
      return;
    }
    updateButtons(btnElement);
    drawChart(hours);
  }

  function updateButtons(activeBtn) {
    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
    if(activeBtn) activeBtn.classList.add('active');
  }

  function drawChart(hours) {
    const now = new Date().getTime();
    const minTime = now - (hours * 60 * 60 * 1000);
    processChart(globalFeeds, minTime, now);
  }

  function handleError(error) {
    console.error("Error:", error);
    document.getElementById('statusText').innerText = "–ü–æ–º–∏–ª–∫–∞";
    document.getElementById('pageLoading').style.display = 'none';
  }

  function calculate3xTimeout(feeds) {
    if (!feeds || feeds.length < 10) return 5;
    const sample = feeds.slice(-50);
    const diffs = [];
    for (let i = 1; i < sample.length; i++) {
      const diff = (new Date(sample[i].created_at) - new Date(sample[i-1].created_at)) / 1000;
      if (diff > 0 && diff < 3600) diffs.push(diff);
    }
    if (diffs.length === 0) return 5;
    diffs.sort((a, b) => a - b);
    const medianSec = diffs[Math.floor(diffs.length / 2)];
    const timeoutSec = medianSec * 3;
    const finalTimeoutMin = Math.max(timeoutSec / 60, 1.5);

    document.getElementById('debugInfo').innerHTML =
            `–Ü–Ω—Ç–µ—Ä–≤–∞–ª –ø—ñ–Ω–≥—ñ–≤: <b>${Math.round(medianSec)} —Å–µ–∫</b>.<br>` +
            `–ü–æ—Ä—ñ–≥ —Ä–æ–∑—Ä–∏–≤—É (3x): <b>${finalTimeoutMin.toFixed(1)} —Ö–≤</b>`;
    return finalTimeoutMin;
  }

  function updateCurrentStatus(feeds) {
    if (!feeds || feeds.length === 0) return;
    const now = new Date().getTime();
    const lastFeed = feeds[feeds.length - 1];
    const lastEntryTime = new Date(lastFeed.created_at).getTime();
    const minutesSinceLast = (now - lastEntryTime) / (1000 * 60);

    const statusIcon = document.getElementById('statusIcon');
    const statusText = document.getElementById('statusText');
    const durationText = document.getElementById('durationText');
    const lastSeen = document.getElementById('lastSeen');

    const isOnline = minutesSinceLast <= detectedTimeoutMinutes;

    if (isOnline) {
      statusIcon.innerText = "üí°";
      statusText.innerText = "–°–≤—ñ—Ç–ª–æ –Ñ";
      statusText.className = "status-text online";
      let startTime = lastEntryTime;
      for (let i = feeds.length - 1; i > 0; i--) {
        const current = new Date(feeds[i].created_at).getTime();
        const prev = new Date(feeds[i-1].created_at).getTime();
        const diffMins = (current - prev) / (1000 * 60);
        if (diffMins > detectedTimeoutMinutes) {
          startTime = current;
          break;
        }
        startTime = prev;
      }
      durationText.innerText = `–¢—Ä–∏–≤–∞—î: ${formatDuration(now - startTime)}`;
      lastSeen.innerText = `–û—Å—Ç–∞–Ω–Ω—ñ–π —Å–∏–≥–Ω–∞–ª: ${new Date(lastEntryTime).toLocaleTimeString()}`;
    } else {
      statusIcon.innerText = "üïØÔ∏è";
      statusText.innerText = "–°–≤—ñ—Ç–ª–∞ –ù–µ–º–∞—î";
      statusText.className = "status-text offline";
      durationText.innerText = `–í—ñ–¥—Å—É—Ç–Ω—î: ${formatDuration(now - lastEntryTime)}`;
      lastSeen.innerText = `–ó–Ω–∏–∫–ª–æ –æ: ${new Date(lastEntryTime).toLocaleTimeString()}`;
    }
  }

  function formatDuration(ms) {
    const totalMinutes = Math.floor(ms / (1000 * 60));
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    if (hours === 0) return `${minutes} —Ö–≤`;
    return `${hours} –≥–æ–¥ ${minutes} —Ö–≤`;
  }

  function processChart(feeds, minTime, maxTime) {
    const ctx = document.getElementById('powerChart').getContext('2d');
    const chartData = [];
    let lastTime = 0;

    const visibleFeeds = feeds.filter(f => new Date(f.created_at).getTime() > (minTime - 3600000));

    visibleFeeds.forEach((feed, index) => {
      const currentTime = new Date(feed.created_at).getTime();
      if (index > 0) {
        const diffMinutes = (currentTime - lastTime) / (1000 * 60);
        if (diffMinutes > detectedTimeoutMinutes) {
          chartData.push({ x: lastTime + 1000, y: 0 });
          chartData.push({ x: currentTime - 1000, y: 0 });
        }
      }
      chartData.push({ x: currentTime, y: 1 });
      lastTime = currentTime;
    });

    const lastEntry = feeds[feeds.length-1];
    if (lastEntry) {
      const lastEntryTime = new Date(lastEntry.created_at).getTime();
      if ((maxTime - lastEntryTime) / 60000 <= detectedTimeoutMinutes) {
        chartData.push({ x: maxTime, y: 1 });
      }
    }

    const nowLineData = [{ x: maxTime, y: 0 }, { x: maxTime, y: 1.1 }];

    let gradient = ctx.createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, 'rgba(52, 199, 89, 0.4)');
    gradient.addColorStop(1, 'rgba(52, 199, 89, 0.05)');

    if (powerChartInstance) powerChartInstance.destroy();

    powerChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [
          {
            label: '–°—Ç–∞–Ω',
            data: chartData,
            borderColor: '#34c759',
            borderWidth: 2,
            backgroundColor: gradient,
            fill: true,
            pointRadius: 0,
            stepped: true,
            order: 2
          },
          {
            label: '–ó–∞—Ä–∞–∑',
            data: nowLineData,
            borderColor: '#ff3b30',
            borderWidth: 1.5,
            borderDash: [5, 5],
            pointRadius: 0,
            fill: false,
            order: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        plugins: { legend: { display: false }, tooltip: { enabled: false } },
        scales: {
          x: {
            type: 'time',
            min: minTime,
            max: maxTime,
            time: { displayFormats: { hour: 'HH:mm', day: 'dd.MM' } },
            grid: {
              display: true, // –£–í–Ü–ú–ö–ù–£–õ–ò –í–ï–†–¢–ò–ö–ê–õ–¨–ù–£ –°–Ü–¢–ö–£
              color: 'rgba(0,0,0,0.05)'
            },
            ticks: {
              maxRotation: 0,
              autoSkip: true,
              maxTicksLimit: 10 // –ó–ë–Ü–õ–¨–®–ò–õ–ò –ö–Ü–õ–¨–ö–Ü–°–¢–¨ –ú–Ü–¢–û–ö –î–û 10
            }
          },
          y: { display: false, min: 0, max: 1.2 }
        }
      }
    });
  }

  function saveChannel() {
    const val = document.getElementById('channelInput').value.trim();
    if(val) {
      localStorage.setItem('ts_channel_id', val);
      location.reload();
    } else {
      alert("–í–≤–µ–¥—ñ—Ç—å ID –∫–∞–Ω–∞–ª—É");
    }
  }

  initialLoad();

  setInterval(() => {
    if(!isFullHistoryLoaded) initialLoad();
  }, 30000);
</script>
</body>
</html>