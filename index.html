<html>
<head>
    <meta http-equiv="refresh" content="120">
</head>
<body>


<button onClick="loadChart(200)">4 часа</button>
<button onClick="loadChart(800)">16 часов</button>
<button onClick="loadChart(1600)">сутки</button>
<button onClick="loadChart(9000)">неделя</button>
<div>
    <canvas id="myChart" height="50"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    function httpGetAsync(theUrl, callback) {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.onreadystatechange = function () {
            if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                callback(xmlHttp.responseText);
            }
        }
        xmlHttp.open("GET", theUrl, true); // true for asynchronous
        xmlHttp.send(null);
    }


    function convertTZ(date, tzString) {
        return new Date((typeof date === "string" ? new Date(date) : date).toLocaleString("en-US", {timeZone: tzString}));
    }

    const ctx = document.getElementById('myChart');
    var chart = new Chart(ctx, {
        type: 'bar',
        data: {datasets: [{data: []}]},
    });

    function loadChart(dataSize) {


        chart.destroy();

        httpGetAsync('https://api.thingspeak.com/channels/1968788/feeds.json?results=' + dataSize,
            function (data) {
                let channels = JSON.parse(data);
                console.log(channels);
                let field1Data = [];
                // let field2Data = [];

                for (let i = 0; i < channels.feeds.length; i++) {
                    let obj = channels.feeds[i];
                    let dateUTC = obj.created_at;
                    let convertedDate = convertTZ(dateUTC, "Europe/Kiev").toLocaleString("en-GB");
                    field1Data[i] = {x: convertedDate, y: obj.field1 === null ? 0 : obj.field1};
                    // field2Data[i] = {x: convertedDate, y: obj.field2};
                }

                chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        //labels: ['Light status', 'Time period'],
                        datasets: [{
                            label: 'Проверка электричества пройдена',
                            data: field1Data,
                            borderWidth: 0,
                            categoryPercentage: 1.0,
                            barPercentage: 2.0,
                        }
                            //,
                            //{
                            //type: 'line',
                            //label: 'Контрольная метка времени',
                            //data: field2Data,
                            //borderWidth: 1
                            //}
                        ]
                    },
                    maintainAspectRatio: false,
                    options: {
                        scales: {
                            y: {
                                display: false,
                                beginAtZero: true,
                                grid: {
                                    drawBorder: false,
                                    color: '#ffffff',
                                },
                            }
                        }
                    }
                });

            }
        );
    }

    loadChart(200);

</script>
</body>
</html>
