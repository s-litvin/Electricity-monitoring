<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –°–≤—ñ—Ç–ª–∞</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    :root {
      --bg-color: #f0f2f5;
      --card-bg: #ffffff;
      --text-main: #1a1a1a;
      --text-sec: #65676b;
      --green: #34c759;
      --red: #ff3b30;
      --accent: #007bff;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #121212;
        --card-bg: #1e1e1e;
        --text-main: #e4e6eb;
        --text-sec: #b0b3b8;
        --input-bg: #2c2c2e;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      margin: 0;
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
    }

    .container { width: 100%; max-width: 600px; }

    /* Status Card */
    .status-card {
      background-color: var(--card-bg);
      border-radius: 20px;
      padding: 25px 20px;
      text-align: center;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      position: relative;
    }

    /* Badge "–û–Ω–æ–≤–ª–µ–Ω–Ω—è" */
    .updating-badge {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 0.8rem;
      color: var(--accent);
      font-weight: 600;
      display: none;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

    .icon { font-size: 3.5rem; margin-bottom: 5px; display: block; }
    .status-text { font-size: 2rem; font-weight: 800; margin: 0; line-height: 1.2;}
    .duration-text { font-size: 1.2rem; font-weight: 500; margin-top: 5px; color: var(--text-sec); }
    .status-sub { color: var(--text-sec); margin-top: 10px; font-size: 0.8rem; opacity: 0.7; }
    .online { color: var(--green); }
    .offline { color: var(--red); }

    /* Controls */
    .controls {
      display: flex; background: var(--card-bg); padding: 5px; border-radius: 12px;
      box-shadow: var(--shadow); margin-bottom: 15px; justify-content: space-between;
    }
    .time-btn {
      flex: 1; border: none; background: transparent; color: var(--text-sec);
      padding: 10px 0; font-size: 0.9rem; font-weight: 600; border-radius: 8px; cursor: pointer; transition: all 0.2s;
    }
    .time-btn.active {
      background-color: var(--text-main); color: var(--card-bg); box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* Chart */
    .chart-card {
      background-color: var(--card-bg); border-radius: 20px; padding: 15px 10px;
      box-shadow: var(--shadow); height: 350px; position: relative; margin-bottom: 20px;
    }

    .chart-loader {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.8);
      display: none; flex-direction: column; justify-content: center; align-items: center;
      z-index: 10; backdrop-filter: blur(2px); border-radius: 20px;
    }
    @media (prefers-color-scheme: dark) { .chart-loader { background: rgba(30, 30, 30, 0.8); } }

    .spinner {
      width: 40px; height: 40px; border: 4px solid var(--text-sec); border-top: 4px solid var(--accent);
      border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Settings */
    .settings-card {
      background-color: var(--card-bg); border-radius: 15px; padding: 15px; box-shadow: var(--shadow);
      display: flex; flex-direction: column; gap: 10px;
    }
    .input-group { display: flex; gap: 10px; }
    input { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--text-sec); background: var(--bg-color); color: var(--text-main); font-size: 1rem; }
    .save-btn { background-color: var(--accent); color: white; border: none; padding: 0 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
    .debug-info { font-size: 0.75rem; color: var(--text-sec); margin-top: 5px; text-align: center; }

    #pageLoading {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-color);
      display: flex; justify-content: center; align-items: center; z-index: 1000; font-size: 1.2rem; font-weight: bold;
    }
  </style>
</head>
<body>

<div id="pageLoading">–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...</div>

<div class="container">
  <div class="status-card" id="statusCard">
    <div class="updating-badge" id="updatingBadge">üîÑ –û–Ω–æ–≤–ª–µ–Ω–Ω—è...</div>

    <span class="icon" id="statusIcon">‚ö°</span>
    <h1 class="status-text" id="statusText">–ê–Ω–∞–ª—ñ–∑...</h1>
    <div class="duration-text" id="durationText">–ó–∞—á–µ–∫–∞–π—Ç–µ</div>
    <div class="status-sub" id="lastSeen"></div>
  </div>

  <div class="controls">
    <button class="time-btn" onclick="changeRange(6, this)">6 –≥–æ–¥</button>
    <button class="time-btn active" onclick="changeRange(12, this)">12 –≥–æ–¥</button>
    <button class="time-btn" onclick="changeRange(24, this)">24 –≥–æ–¥</button>
    <button class="time-btn" onclick="changeRange(168, this)">7 –¥–Ω—ñ–≤</button>
  </div>

  <div class="chart-card">
    <div class="chart-loader" id="chartLoader">
      <div class="spinner"></div>
      <div>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞—Ä—Ö—ñ–≤—É...</div>
    </div>
    <canvas id="powerChart"></canvas>
  </div>

  <div class="settings-card">
    <div class="input-group">
      <input type="text" id="channelInput" placeholder="ThingSpeak Channel ID">
      <button class="save-btn" onclick="saveChannel()">OK</button>
    </div>
    <div class="debug-info" id="debugInfo"></div>
  </div>
</div>

<script>
  // --- URL PARAMS & CONFIG ---
  const urlParams = new URLSearchParams(window.location.search);

  // 1. BotId
  const defaultChannel = '2013961';
  let currentChannelId = urlParams.get('botId') || localStorage.getItem('ts_channel_id') || defaultChannel;
  document.getElementById('channelInput').value = currentChannelId;

  // 2. Clean URL
  updateUrlParams();

  let currentHours = 12;
  const FORCED_TIMEOUT_MINUTES = 10;

  let powerChartInstance = null;
  let globalFeeds = [];
  let isFullHistoryLoaded = false;

  // --- PLUGIN "NOW LINE" ---
  const nowLinePlugin = {
    id: 'nowLine',
    afterDraw: (chart) => {
      const ctx = chart.ctx;
      const xAxis = chart.scales.x;
      const yAxis = chart.scales.y;
      const now = new Date().getTime();

      if (now >= xAxis.min && now <= xAxis.max) {
        const x = xAxis.getPixelForValue(now);
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(x, yAxis.top);
        ctx.lineTo(x, yAxis.bottom);
        ctx.lineWidth = 1.5;
        ctx.strokeStyle = '#ff3b30';
        ctx.setLineDash([5, 5]);
        ctx.stroke();

        // 24-–≥–æ–¥–∏–Ω–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç —á–∞—Å—É –Ω–∞ –≥—Ä–∞—Ñ—ñ–∫—É
        const date = new Date(now);
        const timeString = date.toLocaleTimeString('uk-UA', {hour: '2-digit', minute:'2-digit'});

        ctx.fillStyle = '#ff3b30';
        ctx.font = 'bold 12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(timeString, x, yAxis.top - 5);
        ctx.restore();
      }
    }
  };

  function init() {
    initialLoad();
  }

  async function initialLoad(isBackground = false) {
    const URL = `https://api.thingspeak.com/channels/${currentChannelId}/feeds.json?results=1500`;

    if (isBackground) document.getElementById('updatingBadge').style.display = 'block';

    try {
      const response = await fetch(URL);
      if (!response.ok) throw new Error("Channel error");
      const data = await response.json();

      globalFeeds = data.feeds;
      updateApp();

      if (currentHours !== 168) {
        drawChart(currentHours);
      }

      if (!isBackground) document.getElementById('pageLoading').style.display = 'none';
    } catch (error) {
      console.error(error);
      if (!isBackground) document.getElementById('statusText').innerText = "–ü–æ–º–∏–ª–∫–∞";
    } finally {
      if (isBackground) {
        setTimeout(() => {
          document.getElementById('updatingBadge').style.display = 'none';
        }, 1000);
      }
    }
  }

  async function loadFullHistory() {
    const loader = document.getElementById('chartLoader');
    loader.style.display = 'flex';
    const URL = `https://api.thingspeak.com/channels/${currentChannelId}/feeds.json?results=8000`;
    try {
      const response = await fetch(URL);
      const data = await response.json();

      globalFeeds = data.feeds;
      isFullHistoryLoaded = true;

      updateApp();
      drawChart(168);
      document.getElementById('pageLoading').style.display = 'none';
    } catch (error) {
      alert("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞—Ä—Ö—ñ–≤—É");
    } finally {
      loader.style.display = 'none';
    }
  }

  function updateApp() {
    updateCurrentStatus(globalFeeds);
    document.getElementById('debugInfo').innerText = `ID: ${currentChannelId} | –§—ñ–ª—å—Ç—Ä: > ${FORCED_TIMEOUT_MINUTES} —Ö–≤`;
  }

  function updateCurrentStatus(feeds) {
    if (!feeds || feeds.length === 0) return;
    const now = new Date().getTime();
    const lastFeed = feeds[feeds.length - 1];
    const lastEntryTime = new Date(lastFeed.created_at).getTime();
    const minutesSinceLast = (now - lastEntryTime) / (1000 * 60);

    const statusIcon = document.getElementById('statusIcon');
    const statusText = document.getElementById('statusText');
    const durationText = document.getElementById('durationText');
    const lastSeen = document.getElementById('lastSeen');

    const isOnline = minutesSinceLast <= FORCED_TIMEOUT_MINUTES;

    // 24-–≥–æ–¥–∏–Ω–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç —á–∞—Å—É –¥–ª—è —Ç–µ–∫—Å—Ç—É "–û–Ω–æ–≤–ª–µ–Ω–æ"
    const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
    const timeStr = new Date(lastEntryTime).toLocaleTimeString('uk-UA', timeOptions);
    const disappearTimeStr = new Date(lastEntryTime).toLocaleTimeString('uk-UA', timeOptions);

    if (isOnline) {
      statusIcon.innerText = "üí°";
      statusText.innerText = "–°–≤—ñ—Ç–ª–æ –Ñ";
      statusText.className = "status-text online";

      let startTime = lastEntryTime;
      for (let i = feeds.length - 1; i > 0; i--) {
        const current = new Date(feeds[i].created_at).getTime();
        const prev = new Date(feeds[i-1].created_at).getTime();
        const diffMins = (current - prev) / (1000 * 60);
        if (diffMins > FORCED_TIMEOUT_MINUTES) {
          startTime = current;
          break;
        }
        startTime = prev;
      }
      durationText.innerText = `–¢—Ä–∏–≤–∞—î: ${formatDuration(now - startTime)}`;
      lastSeen.innerText = `–û–Ω–æ–≤–ª–µ–Ω–æ: ${timeStr}`;
    } else {
      statusIcon.innerText = "üïØÔ∏è";
      statusText.innerText = "–°–≤—ñ—Ç–ª–∞ –ù–µ–º–∞—î";
      statusText.className = "status-text offline";
      durationText.innerText = `–í—ñ–¥—Å—É—Ç–Ω—î: ${formatDuration(now - lastEntryTime)}`;
      lastSeen.innerText = `–ó–Ω–∏–∫–ª–æ –æ: ${disappearTimeStr}`;
    }
  }

  function formatDuration(ms) {
    const totalMinutes = Math.floor(ms / (1000 * 60));
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    if (hours === 0) return `${minutes} —Ö–≤`;
    return `${hours} –≥–æ–¥ ${minutes} —Ö–≤`;
  }

  function changeRange(hours, btnElement) {
    currentHours = hours;
    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
    btnElement.classList.add('active');

    if (hours === 168 && !isFullHistoryLoaded) {
      loadFullHistory();
    } else {
      drawChart(hours);
    }
  }

  function drawChart(hours) {
    const now = new Date().getTime();
    const minTime = now - (hours * 60 * 60 * 1000);
    processChart(globalFeeds, minTime, now);
  }

  function processChart(feeds, minTime, maxTime) {
    const ctx = document.getElementById('powerChart').getContext('2d');
    const chartData = [];
    let lastTime = 0;

    const visibleFeeds = feeds.filter(f => new Date(f.created_at).getTime() > (minTime - 3600000));

    visibleFeeds.forEach((feed, index) => {
      const currentTime = new Date(feed.created_at).getTime();
      if (index > 0) {
        const diffMinutes = (currentTime - lastTime) / (1000 * 60);
        if (diffMinutes > FORCED_TIMEOUT_MINUTES) {
          chartData.push({ x: lastTime + 1000, y: 0 });
          chartData.push({ x: currentTime - 1000, y: 0 });
        }
      }
      chartData.push({ x: currentTime, y: 1 });
      lastTime = currentTime;
    });

    const lastEntry = feeds[feeds.length-1];
    if (lastEntry) {
      const lastEntryTime = new Date(lastEntry.created_at).getTime();
      if ((maxTime - lastEntryTime) / 60000 <= FORCED_TIMEOUT_MINUTES) {
        chartData.push({ x: maxTime, y: 1 });
      }
    }

    let gradient = ctx.createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, 'rgba(52, 199, 89, 0.6)');
    gradient.addColorStop(1, 'rgba(52, 199, 89, 0.05)');

    if (powerChartInstance) powerChartInstance.destroy();

    powerChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [{
          data: chartData,
          borderColor: '#34c759',
          borderWidth: 0,
          backgroundColor: gradient,
          fill: true,
          pointRadius: 0,
          stepped: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        layout: { padding: { top: 20 } },
        plugins: { legend: { display: false }, tooltip: { enabled: false } },
        scales: {
          x: {
            type: 'time',
            min: minTime,
            max: maxTime,
            time: { displayFormats: { hour: 'HH:mm', day: 'dd.MM' } },
            grid: { display: true, color: 'rgba(0,0,0,0.05)' },
            ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 8 }
          },
          y: { display: false, min: 0, max: 1.2 }
        }
      },
      plugins: [nowLinePlugin]
    });
  }

  function saveChannel() {
    const val = document.getElementById('channelInput').value.trim();
    if(val) {
      currentChannelId = val;
      localStorage.setItem('ts_channel_id', val);
      updateUrlParams();
      location.reload();
    }
  }

  function updateUrlParams() {
    const url = new URL(window.location);
    url.searchParams.set('botId', currentChannelId);
    url.searchParams.delete('hours');
    window.history.pushState({}, '', url);
  }

  setInterval(() => {
    if (currentHours !== 168) {
      initialLoad(true);
    }
  }, 60000);

  init();

</script>
</body>
</html>